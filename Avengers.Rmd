---
title: "Avengers ELO Analysis"
author: "Emanuele Lena - 142411"
output: pdf_document
---
```{r setup, include=FALSE}
# cache results
# knitr::opts_chunk$set(cache=TRUE, echo = FALSE, eval = FALSE, message=FALSE, warning = FALSE, fig.align='center')
```

## Libraries and functions

```{r}
# library to read the excell file
library(readxl)

# library to make the dataset acceptable
library(tidyr)

# library to have tibbles and manipulate thes easier
library(dplyr)

# library to manipulate strings, in particular I need it 
# for regular expressions 
library(stringr)

library(ggplot2)


# read all the sheets
# https://stackoverflow.com/a/12945838
read_excel_allsheets <- function(filename, tibble = TRUE) {
  
    sheets <- readxl::excel_sheets(filename)
    
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    
    if(!tibble) x <- lapply(x, as.data.frame)
    
    names(x) <- sheets
    
    return(x)
}

```



## Read Data

lorem ipsum ...

```{r}
# read excell dataset
# (now I have a list of tibbles)
raw_avengers_list_of_tibble <- read_excel_allsheets("Avengers.xlsx")

# turn the list of tibble in one single tibble
raw_avengers_tibble <- 
  bind_rows(raw_avengers_list_of_tibble, .id="movie") %>%
  # add ordered  id's
  mutate(id = row_number()) %>%
  select(id, everything())

```


## Tidy the df

Before making the real analysis, I need to tidy my df. In detail I need to...

TODO: LIST

### Manage (winner) charater lists
```{r}


# split rows were winner is a list of charater
raw_avengers_tibble_2 <- raw_avengers_tibble %>%
  mutate(
    divide_loser_n_by = str_count(winner, ",")+1,
  ) %>% 
  separate_rows(winner, sep=",")


```



### Manage "number-charater" pairs
```{r}

# replace "charater" with "1-charater" in df$winner and df$looser
raw_avengers_tibble_3 <- raw_avengers_tibble_2 %>%
  
  # mutate in winner
  mutate(
    winner = ifelse(
      str_detect(winner, "-"), 
      winner, 
      paste("1", winner, sep="-")
      )
  ) %>%
  
  # mutate in loser
  mutate(
    loser = ifelse(
      str_detect(loser, "-"), 
      loser, 
      paste("1", loser, sep="-")
      )
  )


# separate pairs "number-charater name" in 2 columns 
# (in df$winner and df$looser)
fights_tidy <- raw_avengers_tibble_3 %>%
  
  # separate winner
  separate(winner, into=c("winner_n", "winner_charater"), sep="-") %>%
  # separate loser
  separate(loser, into=c("loser_n", "loser_charater"), sep="-") %>%
  
  # convert cols winner_n and loser_n in numbers
  mutate(
    winner_n = as.double(winner_n), 
    loser_n = as.double(loser_n)/divide_loser_n_by
    ) %>% 
  
  
  select(everything(), -one_of(c("divide_loser_n_by")))

# undercase and remove spaces in names
fights_tidy <- fights_tidy %>% 
  mutate(
    winner_charater= str_to_lower(str_replace_all(winner_charater, " ", "")), 
    loser_charater= str_to_lower(str_replace_all(loser_charater, " " , "")), 
  )

```


## Some ramndom statistics about the data frame


### A list of all the charaters
```{r}
all_charaters <- 
  
  # all winners
  fights_tidy %>%
  select(winner_charater) %>% 
  rename(charater=winner_charater) %>%
  
  bind_rows(
    # all losers
    fights_tidy %>%
      select(loser_charater) %>% 
      rename(charater=loser_charater) 
  ) %>%
  distinct() %>%
  mutate(id=row_number()) %>%
  select(id, everything())

# save the dataset
write.csv(all_charaters, "charaters.csv")

```



### Victories, lossen, ecc...
```{r}

# statistics for each charater

# add wins statistics foreach charater
all_charaters_statistics <- fights_tidy %>% 
  group_by(winner_charater) %>%
  summarise(
    n_win = n(), 
  ) %>%
  rename(charater=winner_charater) %>%
  
  # add loss statistics foreach charater
  full_join(
    
    fights_tidy %>% 
      group_by(loser_charater) %>%
      summarise(
        n_lose = n()
      ) %>%
      rename(charater=loser_charater), 
    
    by= "charater"
  ) %>% 
  
  # replace NA values with 0
  replace_na(list(n_win=0, n_lose=0)) %>%
  
  # calculate total fights
  mutate(n_fights = n_win + n_lose) %>%
  
  # arrange by fights number
  arrange(-n_fights) %>%

  # add charater type label
  left_join(all_charaters, by="charater") %>%

  # order columns
  select(charater,n_fights, n_win, n_lose)

all_charaters_statistics


```


## Classifing avengers with ELO


### Prepare the df for elo

```{r}

# remove fights where the number of winners/losers is unknow
fights_tidy_clear <- fights_tidy %>% 
  filter(!is.na(winner_n) & !is.na(loser_n))

# calculate the number of "integer" rows + extra foreach fight
fights_tidy_clear <- fights_tidy_clear %>% 
  mutate(
    number_integer_rows = loser_n %/% winner_n, 
    extra = (loser_n %% winner_n) / winner_n
  )


fights_elo_format_readable <- 
  
  # fights with integer score
  fights_tidy_clear %>% 
  filter(number_integer_rows > 0) %>%
  group_by(id) %>%
  expand(count = seq(1:number_integer_rows), winner=winner_charater, loser=loser_charater, score=1) %>%
  
  bind_rows(
    
    # fights with decimal scores
    fights_tidy_clear %>% 
      filter(extra>0) %>%
      rename(
        winner = winner_charater, 
        loser = loser_charater, 
        score = extra, 
      ) %>% 
      mutate(count = number_integer_rows + 1) %>%
      select(id, count, winner, loser, score)
  ) %>%
  
  arrange(id, count)


# make the score from (0,1] -> (0.5,1]
# (they are all victories)
fights_elo_format_readable <- fights_elo_format_readable %>% 
  mutate(
    score=0.5 + score/2
  )

# insert charater ids
fights_elo_format_readable <- fights_elo_format_readable %>%
  
  # set the id of winner
  left_join(
    all_charaters %>% rename(winner_id = id), 
    by=c("winner"="charater")
  ) %>%
  
  # # set the id of winner
  left_join(
    all_charaters %>% rename(loser_id = id), 
    by=c("loser"="charater")
  )
  
fights_elo_format <- fights_elo_format_readable %>%
  # set correct var names
  rename(White=winner_id, Black=loser_id, Score=score)

# save the dataset
write.csv(fights_elo_format, "fights_elo_format.csv")

fights_elo_format
    
```


### The ELO Algorithm

```{r}

##  Elo rating system
# INPUT
# games: a game *matrix* with columns White, Black and Score
#        Players are integer numbers starting at 1
#        The matrix is sorted in chronological order
# zeta: logistic parameter
# k: update factor
# OUTPUT
# r: rating vector
elo = function(games, z = 400, k = 25) {
  
  # number of players 
  # (players are integer numbers starting at 1)
  n = max(c(games[, "White"], games[, "Black"]))

  # number of games
  m = nrow(games)
  
  # rating vector
  r = rep(0, n)
  
  # iterate through games
  for (i in 1:m) {
    score = games[i, "Score"]
    white = games[i, "White"]
    black = games[i, "Black"]

    # compute update
    spread = r[white] - r[black]
    mu = 1 / (1 + 10^(-spread / z))
    update = k * (score - mu)
    
    # update ratings
    r[white] = r[white] + update
    r[black] = r[black] - update
    
  }
  return(r)
}


```


### First test
```{r}

scores_list <- elo(as.data.frame(fights_elo_format))

scores <- 
  tibble(score = scores_list) %>%
  mutate(id = row_number()) %>%
  select(id, everything()) %>%
  left_join(all_charaters, by="id") %>%
  arrange(-score)



ggplot(data=scores %>% head(), mapping = aes(x=reorder(charater, -score), y=score)) +
  geom_bar(stat="identity")

print(scores)



```

```{r}


```









